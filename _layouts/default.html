<!doctype html>
<html lang="en">
<head>
  {% include head.html %}

  <style>
    :root{
      /* Set your actual nav height if different */
      --nav-h: 84px;

      /* Watermark logo (color version by default) */
      --bg-logo-url: url('{{ "/assets/img/logo-mark-color.png" | relative_url }}');
    }

    /* ---- Site-wide watermark behind everything ---- */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: var(--bg-logo-url) no-repeat center center;
      background-size: min(80vw, 840px);
      opacity: .085;
      filter: blur(1.5px);
      z-index: 0;
      pointer-events: none;
    }

    /* Ensure page content sits above the fixed bg logo */
    .site-wrapper, main, header, footer { position: relative; z-index: 1; }

    /* ===================== NAV / MOBILE DRAWER ===================== */

    /* Your top nav should always be above page content */
    .nav{ position: sticky; top: 0; z-index: 5000; }

    /* Full-screen overlay behind the drawer (but under the nav) */
    .nav-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease;
      z-index: 4500;
    }
    .nav-overlay.show{ opacity: 1; pointer-events: auto; }

    /* Mobile drawer panel (slides in under the nav bar) */
    .mobile-drawer{
      position: fixed; left: 0; right: 0; top: var(--nav-h,84px);
      height: calc(100dvh - var(--nav-h,84px));
      background: #fff;
      border-top: 1px solid var(--nav-border, #e5e7eb);
      transform: translateY(-8px);
      opacity: 0; pointer-events: none;
      transition: transform .18s ease, opacity .18s ease;
      z-index: 4600;
      display: flex; flex-direction: column;
      will-change: transform, opacity;
    }
    .mobile-drawer.open{
      transform: none;
      opacity: 1;
      pointer-events: auto;
    }
    .mobile-drawer a{
      padding: 14px 20px;
      border-top: 1px solid var(--nav-border, #e5e7eb);
      color: var(--ink, #0b1220);
      background: #fff;
    }

    /* Keep the hamburger button on top so it’s always tappable */
    .menu-btn{ position: relative; z-index: 5001; }

    /* Lock the page scroll when the drawer is open */
    body.nav-open{ overflow: hidden; touch-action: none; }

    /* ===================== MINI CART (as you had it) ===================== */
    .mini-cart{
      position:fixed; top:0; right:-380px; width:340px; height:100%; background:#fff;
      box-shadow:-4px 0 16px rgba(0,0,0,.12); display:flex; flex-direction:column; z-index:9999;
      transition:right .3s ease;
    }
    .mini-cart.open{ right:0; }
    .cart-header{ display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid var(--border); }
    .cart-items{ flex:1; overflow:auto; padding:1rem; }
    .cart-item{ display:flex; gap:.75rem; align-items:center; margin-bottom:1rem; }
    .cart-item img{ width:60px; height:60px; object-fit:cover; border-radius:6px; }
    .cart-item-title{ font-size:.95rem; margin-bottom:.25rem; }
    .cart-item-qty{ display:flex; gap:.25rem; align-items:center; }
    .cart-item-qty button{ border:1px solid var(--border); background:#f7f7f7; padding:.25rem .5rem; cursor:pointer; }
    .cart-footer{ display:flex; justify-content:space-between; align-items:center; gap:.75rem; padding:1rem; border-top:1px solid var(--border); }
    .cart-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:9998; }
    .cart-overlay.show{ display:block; }

    /* (Optional) If you previously had a minimal drawer style, remove it.
       This file fully replaces the drawer CSS. */
  </style>
</head>

<script>
(function () {
  function closeDrawer() {
    document.querySelector('.mobile-drawer')?.classList.remove('open');
    document.getElementById('nav-overlay')?.classList.remove('show');
    document.body.classList.remove('nav-open');
  }

  function scrollToCenter(hash) {
    const el = document.querySelector(hash);
    if (!el) return;

    // Where would the element’s center be on the page?
    const rect = el.getBoundingClientRect();
    const targetY = window.scrollY + rect.top + (rect.height / 2) - (window.innerHeight / 2);

    const behavior = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : 'smooth';
    window.scrollTo({ top: Math.max(0, targetY), behavior });
  }

  // Clicks on any link to #contact -> center it
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[href="#contact"]');
    if (!a) return;
    e.preventDefault();
    closeDrawer();
    scrollToCenter('#contact');
    // keep URL hash for sharing/back button
    if (location.hash !== '#contact') history.pushState(null, '', '#contact');
  });

  // If someone lands directly on /#contact or navigates to it
  function maybeCenterHash() {
    if (location.hash === '#contact') setTimeout(() => scrollToCenter('#contact'), 50);
  }
  maybeCenterHash();
  window.addEventListener('hashchange', maybeCenterHash);
})();
</script>



<body class="theme-navy">

  <!-- Mini Cart Drawer -->
  <div id="mini-cart" class="mini-cart">
    <div class="cart-header">
      <h2>Your Cart</h2>
      <button id="close-cart" aria-label="Close cart">&times;</button>
    </div>
    <div class="cart-items"><!-- rendered by JS --></div>
    <div class="cart-footer">
      <div>
        <span class="cart-total-label">Total:</span>
        <span class="cart-total-price" data-cart-total>$0.00</span>
      </div>
      <button class="btn primary>Checkout</button>
    </div>
  </div>

  <!-- Overlays -->
  <div id="cart-overlay" class="cart-overlay"></div>

  <div class="site-wrapper">
    {% include nav.html %}
    <div id="nav-overlay" class="nav-overlay"></div>

    <main id="content">
      {{ content }}
    </main>

    <div class="sep"></div>
    {% include contact-strip.html %}

    <!-- Sponsors-as-footer -->
    <footer class="site-footer" role="contentinfo">
      <div class="container">
        {% include sponsors-grid.html %}
        <div class="legal">© {{ "now" | date: "%Y" }} Team Macuga. All rights reserved.</div>
      </div>
    </footer>
  </div>

  <!-- ===================== SCRIPTS ===================== -->

  <!-- Carousels + shop helpers -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tiny rotator for .carousel (bios)
    document.querySelectorAll('.carousel').forEach(car=>{
      const slides=[...car.querySelectorAll('.slide')];
      const dots=[...car.querySelectorAll('.dots button')];
      let i=0; const show=n=>{
        slides.forEach((s,k)=>s.classList.toggle('active',k===n));
        dots.forEach((d,k)=>d.classList.toggle('active',k===n));
        i=n;
      };
      dots.forEach((d,idx)=>d.addEventListener('click',()=>show(idx)));
      if(slides.length>1) setInterval(()=>show((i+1)%slides.length), 4500);
    });

    // Shop filters/sort (if present)
    const grid = document.getElementById('products');
    if(grid){
      const chips = document.querySelectorAll('.shop-controls .chip');
      const sortSel = document.getElementById('sortPrice');

      const filter = cat => document.querySelectorAll('.product-card')
        .forEach(c => c.classList.toggle('hide', !(cat==='all'||(c.dataset.cat||'').includes(cat))));

      chips.forEach(ch => ch.addEventListener('click', () => {
        chips.forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        filter(ch.dataset.filter);
      }));

      sortSel?.addEventListener('change', ()=>{
        const cards=[...document.querySelectorAll('.product-card')];
        if(sortSel.value!=='default'){
          const dir = sortSel.value==='asc'?1:-1;
          cards.sort((a,b)=>(parseFloat(a.dataset.price)-parseFloat(b.dataset.price))*dir);
        }
        cards.forEach(c=>grid.appendChild(c));
      });
    }
  });
  </script>

  <script defer src="{{ '/assets/js/carousel.js' | relative_url }}"></script>

  <!-- Mini cart behavior -->
  <script>
  (function(){
    const SHOP = '{{ site.shopify.domain | default: "yourshop.myshopify.com" }}';
    const KEY = 'tm_cart';

    const drawer = document.getElementById('mini-cart');
    const overlay = document.getElementById('cart-overlay');

    const get = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const set = (c) => localStorage.setItem(KEY, JSON.stringify(c));
    const count = () => get().reduce((n,i)=>n + (i.qty||0), 0);

    function openCart(){ drawer?.classList.add('open'); overlay?.classList.add('show'); }
    function closeCart(){ drawer?.classList.remove('open'); overlay?.classList.remove('show'); }

    function updateBadge(){
      document.querySelectorAll('[data-cart-count]').forEach(el=> el.textContent = count());
    }

    function renderCart(){
      const list = drawer?.querySelector('.cart-items');
      const totalEl = drawer?.querySelector('[data-cart-total]');
      updateBadge();
      if(!list || !totalEl) return;

      const cart = get();
      list.innerHTML = '';
      if(!cart.length){
        list.innerHTML = '<p>Your cart is empty.</p>';
        totalEl.textContent = '$0.00';
        return;
      }

      let total = 0;
      cart.forEach(item=>{
        const price = parseFloat(item.price) || 0;
        total += price * (item.qty || 1);
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src="${item.img || ''}" alt="">
          <div class="cart-item-details" style="flex:1">
            <div class="cart-item-title">${item.title || 'Item'}</div>
            <div class="cart-item-qty">
              <button data-dec="${item.id}">-</button>
              <span>${item.qty || 1}</span>
              <button data-inc="${item.id}">+</button>
              <button data-remove="${item.id}">Remove</button>
            </div>
            <div class="cart-item-price">$${price.toFixed(2)}</div>
          </div>
        `;
        list.appendChild(row);
      });

      totalEl.textContent = `$${total.toFixed(2)}`;
    }

    function add(id, qty, title, price, img){
      id = String(id);
      qty = Math.max(1, parseInt(qty || 1, 10));
      const cart = get();
      const item = cart.find(i=>i.id===id);
      if(item){ item.qty += qty; }
      else { cart.push({ id, qty, title, price, img }); }
      set(cart); renderCart(); openCart();
    }

    function changeQty(id, delta){
      const cart = get();
      const it = cart.find(i=>i.id===id);
      if(!it) return;
      it.qty = Math.max(1, (it.qty||1) + delta);
      set(cart); renderCart();
    }

    function remove(id){
      set(get().filter(i=>i.id!==id)); renderCart();
    }

    function checkout(){
      const cart = get();
      if(!cart.length){ openCart(); return; }
      const parts = cart.map(i=>`${i.id}:${i.qty}`).join(',');
      window.location.href = `https://${SHOP}/cart/${parts}`;
    }

    window.addEventListener('tm:add', (e)=> {
      const d = e.detail || {};
      add(d.id, d.qty, d.title, d.price, d.img);
    });
    window.addEventListener('tm:remove', (e)=> remove(String(e.detail?.id || '')));

    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.closest('[data-open-cart]') || t.closest('#open-cart')){ e.preventDefault(); openCart(); return; }
      if(t.closest('#close-cart') || t.closest('#cart-overlay')){ e.preventDefault(); closeCart(); return; }
      if(t.closest('[data-checkout]')){ e.preventDefault(); checkout(); return; }

      const inc = t.closest('[data-inc]');
      const dec = t.closest('[data-dec]');
      const rem = t.closest('[data-remove]');
      if(inc){ changeQty(inc.dataset.inc, +1); return; }
      if(dec){ changeQty(dec.dataset.dec, -1); return; }
      if(rem){ remove(rem.dataset.remove); return; }
    });

    renderCart();
  })();
  </script>

  <!-- Robust mobile menu toggle -->
  <script>
  (function(){
    const btn     = document.querySelector('.menu-btn');
    const drawer  = document.querySelector('.mobile-drawer');
    const overlay = document.getElementById('nav-overlay');

    if(!btn || !drawer || !overlay) return;

    const open = () => {
      drawer.classList.add('open');
      overlay.classList.add('show');
      document.body.classList.add('nav-open');
      btn.setAttribute('aria-expanded', 'true');
    };
    const close = () => {
      drawer.classList.remove('open');
      overlay.classList.remove('show');
      document.body.classList.remove('nav-open');
      btn.setAttribute('aria-expanded', 'false');
    };
    const toggle = () => (drawer.classList.contains('open') ? close() : open());

    // open/close on button tap
    btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(); }, { passive:false });

    // close on overlay
    overlay.addEventListener('click', close);

    // close on ESC
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

    // close when tapping any link inside the drawer (including #anchors)
    drawer.addEventListener('click', (e)=>{
      const a = e.target.closest('a');
      if(a) close();
    });

    // close on hash changes (in-page jumps)
    window.addEventListener('hashchange', close);
  })();
  </script>

  <script>
  (function () {
    const v = document.getElementById('heroVideo');
    if (!v) return;

    // iOS requirements for autoplay
    v.muted = true;
    v.playsInline = true;

    // Move data-src -> src so the browser starts fetching after first paint
    const s = v.querySelector('source');
    if (s && s.dataset.src) {
      s.src = s.dataset.src;
      v.load();
    }

    // Try to start the moment it’s ready to render frames
    function start() {
      v.play().catch(() => {
        // Autoplay blocked? Keep poster and set a class if you want to style a fallback
        document.documentElement.classList.add('hero-video-fallback');
      });
    }

    if (v.readyState >= 3) {
      // HAVE_FUTURE_DATA — already safe to play
      start();
    } else {
      v.addEventListener('canplaythrough', start, { once: true });
      // safety: if network is slow, try on first frame too
      v.addEventListener('canplay', start, { once: true });
    }
  })();
  </script>

</body>
</html>
