<!doctype html>
<html lang="en">
<head>
  {% include head.html %}

  <style>
    :root{
      --bg-logo-url: url('{{ "/assets/img/logo-mark-color.png" | relative_url }}');
    }

    /* keeps logo fixed behind everything */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: var(--bg-logo-url) no-repeat center center;
      background-size: min(80vw, 840px);
      opacity: .085;
      filter: blur(1.5px);
      z-index: 0;
      pointer-events: none;
    }

    /* ensure page content sits above the fixed bg logo */
    .site-wrapper, main, header, footer { position: relative; z-index: 1; }
  </style>
</head>

<script>
(function(){
  const SHOP = '{{ site.shopify.domain | default: "yourshop.myshopify.com" }}';
  const KEY = 'tm_cart';

  const get = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const set = (c) => localStorage.setItem(KEY, JSON.stringify(c));
  const count = () => get().reduce((n,i)=>n+i.qty,0);

  function add(id, qty){
    const cart = get();
    const item = cart.find(i=>i.id===id);
    item ? item.qty += qty : cart.push({ id, qty, title: document.querySelector('h1')?.textContent || 'Item', img: document.querySelector('#hero')?.src });
    set(cart); updateUI();
  }

  function remove(id){
    set(get().filter(i=>i.id!==id)); updateUI();
  }

  function updateUI(){
    // Update badge
    document.querySelectorAll('[data-cart-count]').forEach(el=> el.textContent = count());
    // Update drawer list
    const itemsWrap = document.querySelector('.cart-items');
    const totalEl = document.querySelector('[data-cart-total]');
    if(!itemsWrap) return;

    const cart = get();
    itemsWrap.innerHTML = '';
    let total = 0;
    cart.forEach(item=>{
      total += (item.price || 0) * item.qty;

      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <img src="${item.img || ''}" alt="">
        <div class="cart-item-details">
          <div class="cart-item-title">${item.title || 'Item'}</div>
          <div class="cart-item-qty">
            <button data-dec="${item.id}">-</button>
            <span>${item.qty}</span>
            <button data-inc="${item.id}">+</button>
            <button data-remove="${item.id}">Remove</button>
          </div>
        </div>
      `;
      itemsWrap.appendChild(row);
    });
    totalEl.textContent = `$${total.toFixed(2)}`;
  }

  function checkout(){
    const cart = get();
    if(!cart.length) return;
    const parts = cart.map(i=>`${i.id}:${i.qty}`).join(',');
    window.location.href = `https://${SHOP}/cart/${parts}`;
  }

  // Event wiring
  window.addEventListener('tm:add', (e)=> add(e.detail.id, e.detail.qty||1));
  window.addEventListener('tm:remove', (e)=> remove(e.detail.id));
  document.addEventListener('click', (e)=>{
    if(e.target.matches('[data-checkout]')){ e.preventDefault(); checkout(); }
    if(e.target.matches('#open-cart')){ document.getElementById('mini-cart').classList.add('open'); document.getElementById('cart-overlay').classList.add('show'); }
    if(e.target.matches('#close-cart') || e.target.matches('#cart-overlay')){ document.getElementById('mini-cart').classList.remove('open'); document.getElementById('cart-overlay').classList.remove('show'); }
    if(e.target.dataset.inc){ const id = e.target.dataset.inc; const cart = get(); const it = cart.find(x=>x.id===id); if(it){it.qty++; set(cart); updateUI();} }
    if(e.target.dataset.dec){ const id = e.target.dataset.dec; const cart = get(); const it = cart.find(x=>x.id===id); if(it && it.qty>1){it.qty--; set(cart); updateUI();} }
    if(e.target.dataset.remove){ remove(e.target.dataset.remove); }
  });

  // Init
  updateUI();
})();
</script>


<body>
  <div class="site-wrapper">
    {% include nav.html %}

    <main id="content">
      {{ content }}
    </main>

    <div class="sep"></div>
    {% include contact-strip.html %}

    <footer class="container">
      Â© {{ "now" | date: "%Y" }} Team Macuga. All rights reserved.
    </footer>
  </div>

  <!-- scripts (keep at end of body) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tiny rotator for .carousel (bios)
    document.querySelectorAll('.carousel').forEach(car=>{
      const slides=[...car.querySelectorAll('.slide')];
      const dots=[...car.querySelectorAll('.dots button')];
      let i=0; const show=n=>{
        slides.forEach((s,k)=>s.classList.toggle('active',k===n));
        dots.forEach((d,k)=>d.classList.toggle('active',k===n));
        i=n;
      };
      dots.forEach((d,idx)=>d.addEventListener('click',()=>show(idx)));
      if(slides.length>1) setInterval(()=>show((i+1)%slides.length), 4500);
    });

    // Shop filters/sort (if present)
    const grid = document.getElementById('products');
    if(grid){
      const chips = document.querySelectorAll('.shop-controls .chip');
      const sortSel = document.getElementById('sortPrice');
      const filter = cat => document.querySelectorAll('.product-card')
        .forEach(c => c.classList.toggle('hide', !(cat==='all'||(c.dataset.cat||'').includes(cat))));
      chips.forEach(ch => ch.addEventListener('click', ()=>{
        chips.forEach(c=>c.removeAttribute('class')); 
        ch.classList.add('chip','active');
        filter(ch.dataset.filter);
      }));
      sortSel?.addEventListener('change', ()=>{
        const cards=[...document.querySelectorAll('.product-card')];
        if(sortSel.value!=='default'){
          const dir = sortSel.value==='asc'?1:-1;
          cards.sort((a,b)=>(parseFloat(a.dataset.price)-parseFloat(b.dataset.price))*dir);
        }
        cards.forEach(c=>grid.appendChild(c));
      });
    }
  });
  </script>

  <script defer src="{{ '/assets/js/carousel.js' | relative_url }}"></script>

  <script>
  (function(){
    const blocks = document.querySelectorAll('.mini-rotator');
    blocks.forEach(block => {
      const slides = Array.from(block.querySelectorAll('.slide'));
      if (slides.length < 2) return;

      // dots
      const dotsWrap = block.querySelector('.dots');
      slides.forEach((_, i) => {
        const b = document.createElement('button');
        b.addEventListener('click', () => go(i));
        dotsWrap.appendChild(b);
      });

      let idx = 0, timer;
      const dots = dotsWrap.querySelectorAll('button');

      function go(n){
        slides[idx].classList.remove('active');
        dots[idx].classList.remove('active');
        idx = (n + slides.length) % slides.length;
        slides[idx].classList.add('active');
        dots[idx].classList.add('active');
      }
      function start(){ timer = setInterval(() => go(idx+1), 3500); }
      function stop(){ clearInterval(timer); }

      go(0); start();
      block.addEventListener('mouseenter', stop);
      block.addEventListener('mouseleave', start);
    });
  })();
  </script>
</body>

<!-- Mini Cart Drawer -->
<div id="mini-cart" class="mini-cart">
  <div class="cart-header">
    <h2>Your Cart</h2>
    <button id="close-cart">&times;</button>
  </div>
  <div class="cart-items"></div>
  <div class="cart-footer">
    <span class="cart-total-label">Total:</span>
    <span class="cart-total-price" data-cart-total>$0.00</span>
    <button class="btn" data-checkout>Checkout</button>
  </div>
</div>

<!-- Overlay -->
<div id="cart-overlay" class="cart-overlay"></div>

</html>
