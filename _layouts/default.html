<!doctype html>
<html lang="en">
<head>
  {% include head.html %}

  <style>
    :root{
      --bg-logo-url: url('{{ "/assets/img/logo-mark-color.png" | relative_url }}');
    }

    /* keeps logo fixed behind everything */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: var(--bg-logo-url) no-repeat center center;
      background-size: min(80vw, 840px);
      opacity: .085;
      filter: blur(1.5px);
      z-index: 0;
      pointer-events: none;
    }

    /* ensure page content sits above the fixed bg logo */
    .site-wrapper, main, header, footer { position: relative; z-index: 1; }

    /* --- Mini-cart + overlay (quick styles) --- */
    .mini-cart{
      position:fixed; top:0; right:-380px; width:340px; height:100%; background:#fff;
      box-shadow:-4px 0 16px rgba(0,0,0,.12); display:flex; flex-direction:column; z-index:9999;
      transition:right .3s ease;
    }
    .mini-cart.open{ right:0; }
    .cart-header{ display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid var(--border); }
    .cart-items{ flex:1; overflow:auto; padding:1rem; }
    .cart-item{ display:flex; gap:.75rem; align-items:center; margin-bottom:1rem; }
    .cart-item img{ width:60px; height:60px; object-fit:cover; border-radius:6px; }
    .cart-item-title{ font-size:.95rem; margin-bottom:.25rem; }
    .cart-item-qty{ display:flex; gap:.25rem; align-items:center; }
    .cart-item-qty button{ border:1px solid var(--border); background:#f7f7f7; padding:.25rem .5rem; cursor:pointer; }
    .cart-footer{ display:flex; justify-content:space-between; align-items:center; gap:.75rem; padding:1rem; border-top:1px solid var(--border); }
    .cart-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:9998; }
    .cart-overlay.show{ display:block; }

    /* mobile drawer should not intercept clicks when closed */
    .mobile-drawer{ pointer-events:none; opacity:0; transform:translateY(-6px); transition:opacity .2s, transform .2s; }
    .mobile-drawer.open{ pointer-events:auto; opacity:1; transform:none; }
    
  </style>
</head>

<body class="theme-navy">

  <!-- Mini Cart Drawer (preview) -->
  <div id="mini-cart" class="mini-cart">
    <div class="cart-header">
      <h2>Your Cart</h2>
      <button id="close-cart" aria-label="Close cart">&times;</button>
    </div>
    <div class="cart-items"><!-- rendered by JS --></div>
    <div class="cart-footer">
      <div>
        <span class="cart-total-label">Total:</span>
        <span class="cart-total-price" data-cart-total>$0.00</span>
      </div>
      <button class="btn" data-checkout>Checkout</button>
    </div>
  </div>

  <!-- Overlay -->
  <div id="cart-overlay" class="cart-overlay"></div>

  <div class="site-wrapper">
    {% include nav.html %}
    <div id="nav-overlay" class="nav-overlay"></div>
   
    <main id="content">
      {{ content }}
    </main>

    <div class="sep"></div>
    {% include contact-strip.html %}

    <footer class="site-footer" role="contentinfo">
    <div class="container">
      {% include sponsors-grid.html %}
      <div class="legal">© {{ "now" | date: "%Y" }} Team Macuga. All rights reserved.</div>
    </div>
  </footer>
  </div>

  <!-- scripts (keep at end of body) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tiny rotator for .carousel (bios)
    document.querySelectorAll('.carousel').forEach(car=>{
      const slides=[...car.querySelectorAll('.slide')];
      const dots=[...car.querySelectorAll('.dots button')];
      let i=0; const show=n=>{
        slides.forEach((s,k)=>s.classList.toggle('active',k===n));
        dots.forEach((d,k)=>d.classList.toggle('active',k===n));
        i=n;
      };
      dots.forEach((d,idx)=>d.addEventListener('click',()=>show(idx)));
      if(slides.length>1) setInterval(()=>show((i+1)%slides.length), 4500);
    });

    // Shop filters/sort (if present)
    const grid = document.getElementById('products');
    if(grid){
      const chips = document.querySelectorAll('.shop-controls .chip');
      const sortSel = document.getElementById('sortPrice');
      const filter = cat => document.querySelectorAll('.product-card')
        .forEach(c => c.classList.toggle('hide', !(cat==='all'||(c.dataset.cat||'').includes(cat))));
      // SAFE — only toggles 'active'
      chips.forEach(ch => ch.addEventListener('click', () => {
        chips.forEach(c => c.classList.remove('active'));
        ch.classList.add('active');
        filter(ch.dataset.filter);
      }));

      sortSel?.addEventListener('change', ()=>{
        const cards=[...document.querySelectorAll('.product-card')];
        if(sortSel.value!=='default'){
          const dir = sortSel.value==='asc'?1:-1;
          cards.sort((a,b)=>(parseFloat(a.dataset.price)-parseFloat(b.dataset.price))*dir);
        }
        cards.forEach(c=>grid.appendChild(c));
      });
    }
  });
  </script>

  <script defer src="{{ '/assets/js/carousel.js' | relative_url }}"></script>

  <script>
  (function(){
    const SHOP = '{{ site.shopify.domain | default: "yourshop.myshopify.com" }}';
    const KEY = 'tm_cart';

    const drawer = document.getElementById('mini-cart');
    const overlay = document.getElementById('cart-overlay');

    const get = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const set = (c) => localStorage.setItem(KEY, JSON.stringify(c));
    const count = () => get().reduce((n,i)=>n + (i.qty||0), 0);

    function openCart(){ drawer?.classList.add('open'); overlay?.classList.add('show'); }
    function closeCart(){ drawer?.classList.remove('open'); overlay?.classList.remove('show'); }

    function updateBadge(){
      document.querySelectorAll('[data-cart-count]').forEach(el=> el.textContent = count());
    }

    function renderCart(){
      const list = drawer?.querySelector('.cart-items');
      const totalEl = drawer?.querySelector('[data-cart-total]');

      // Always update the badge
      updateBadge();

      if(!list || !totalEl) return;

      const cart = get();
      list.innerHTML = '';

      if(!cart.length){
        list.innerHTML = '<p>Your cart is empty.</p>';
        totalEl.textContent = '$0.00';
        return;
      }

      let total = 0;
      cart.forEach(item=>{
        const price = parseFloat(item.price) || 0;
        total += price * (item.qty || 1);

        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src="${item.img || ''}" alt="">
          <div class="cart-item-details" style="flex:1">
            <div class="cart-item-title">${item.title || 'Item'}</div>
            <div class="cart-item-qty">
              <button data-dec="${item.id}">-</button>
              <span>${item.qty || 1}</span>
              <button data-inc="${item.id}">+</button>
              <button data-remove="${item.id}">Remove</button>
            </div>
            <div class="cart-item-price">$${price.toFixed(2)}</div>
          </div>
        `;
        list.appendChild(row);
      });

      totalEl.textContent = `$${total.toFixed(2)}`;
    }

    function add(id, qty, title, price, img){
      id = String(id);
      qty = Math.max(1, parseInt(qty || 1, 10));
      const cart = get();
      const item = cart.find(i=>i.id===id);
      if(item){ item.qty += qty; }
      else { cart.push({ id, qty, title, price, img }); }
      set(cart); renderCart(); openCart();
    }

    function changeQty(id, delta){
      const cart = get();
      const it = cart.find(i=>i.id===id);
      if(!it) return;
      it.qty = Math.max(1, (it.qty||1) + delta);
      set(cart); renderCart();
    }

    function remove(id){
      set(get().filter(i=>i.id!==id)); renderCart();
    }

    function checkout(){
      const cart = get();
      if(!cart.length){ openCart(); return; }
      const parts = cart.map(i=>`${i.id}:${i.qty}`).join(',');
      window.location.href = `https://${SHOP}/cart/${parts}`;
    }

    // Events from product pages / grid quick-add
    window.addEventListener('tm:add', (e)=> {
      const d = e.detail || {};
      add(d.id, d.qty, d.title, d.price, d.img);
    });
    window.addEventListener('tm:remove', (e)=> remove(String(e.detail?.id || '')));

    // Open/close/checkout + qty buttons (use closest for nested clicks)
    document.addEventListener('click', (e)=>{
      const t = e.target;

      if(t.closest('[data-open-cart]') || t.closest('#open-cart')){ e.preventDefault(); openCart(); return; }
      if(t.closest('#close-cart') || t.closest('#cart-overlay')){ e.preventDefault(); closeCart(); return; }
      if(t.closest('[data-checkout]')){ e.preventDefault(); checkout(); return; }

      const inc = t.closest('[data-inc]');
      const dec = t.closest('[data-dec]');
      const rem = t.closest('[data-remove]');
      if(inc){ changeQty(inc.dataset.inc, +1); return; }
      if(dec){ changeQty(dec.dataset.dec, -1); return; }
      if(rem){ remove(rem.dataset.remove); return; }
    });

    // Init
    renderCart();
  })();
  </script>

  <script>
  (function(){
    const blocks = document.querySelectorAll('.mini-rotator');
    blocks.forEach(block => {
      const slides = Array.from(block.querySelectorAll('.slide'));
      if (slides.length < 2) return;

      // dots
      const dotsWrap = block.querySelector('.dots');
      slides.forEach((_, i) => {
        const b = document.createElement('button');
        b.addEventListener('click', () => go(i));
        dotsWrap.appendChild(b);
      });

      let idx = 0, timer;
      const dots = dotsWrap.querySelectorAll('button');

      function go(n){
        slides[idx].classList.remove('active');
        dots[idx].classList.remove('active');
        idx = (n + slides.length) % slides.length;
        slides[idx].classList.add('active');
        dots[idx].classList.add('active');
      }
      function start(){ timer = setInterval(() => go(idx+1), 3500); }
      function stop(){ clearInterval(timer); }

      go(0); start();
      block.addEventListener('mouseenter', stop);
      block.addEventListener('mouseleave', start);
    });
  })();
  </script>

  <script>
  (function(){
    const btn = document.querySelector('.menu-btn');
    const drawer = document.querySelector('.mobile-drawer');
    const overlay = document.getElementById('nav-overlay');
    if(!btn || !drawer) return;
    const toggle = () => {
      drawer.classList.toggle('open');
      overlay?.classList.toggle('show');
      document.body.classList.toggle('nav-open');
    };
    btn.addEventListener('click', toggle);
    overlay?.addEventListener('click', toggle);
  })();

  // Close mobile drawer when clicking any in-page anchor
  document.querySelectorAll('.links a[href^="#"]').forEach(a=>{
    a.addEventListener('click', ()=>{
      document.querySelector('.mobile-drawer')?.classList.remove('open');
      document.getElementById('nav-overlay')?.classList.remove('show');
      document.body.classList.remove('nav-open');
    });
  });

  </script>

  <script>
  (function(){
    const v = document.querySelector('.hero-video video');
    if(!v) return;

    // Required for iOS autoplay
    v.muted = true;
    v.playsInline = true;

    function tryPlay(){
      v.play().catch(() => {
        // If autoplay is blocked, fall back to poster background
        document.documentElement.classList.add('hero-video-fallback');
      });
    }

    if (document.readyState === 'complete') tryPlay();
    else window.addEventListener('load', tryPlay);
  })();
  </script>


</body>
</html>
