{% comment %} Assumes page.images is a hash: { "Color": [img1, img2, ...], ... } {% endcomment %}

<article class="product container">
  <div class="product-grid">
    <div class="gallery">
      <img id="hero" src="{{ page.featured_image | relative_url }}" alt="{{ page.title }}">
      {% if page.images and page.images.size > 0 %}
      <div class="thumbs">
        {% for color, imgs in page.images %}
          {% for img in imgs %}
            <button class="thumb" data-color="{{ color }}"><img src="{{ img | relative_url }}" alt="{{ page.title }} - {{ color }}"></button>
          {% endfor %}
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <div class="details">
      {% if page.badge %}
        {% assign br = page.badge | downcase | strip %}
        {% if br contains 'collab' %}
          {% assign badge_key = 'collab' %}
        {% elsif br contains 'best' %}
          {% assign badge_key = 'bestseller' %}
        {% elsif br contains 'new' %}
          {% assign badge_key = 'new' %}
        {% elsif br contains 'limited' %}
          {% assign badge_key = 'limited' %}
        {% elsif br contains 'sale' %}
          {% assign badge_key = 'sale' %}
        {% else %}
          {% assign badge_key = br | replace: ' ', '-' | replace: '!', '' | replace: '.', '' %}
        {% endif %}

        <span class="badge badge-{{ badge_key }}">{{ page.badge }}</span>
      {% endif %}

      <h1>{{ page.title }}</h1>
      <p class="price">${{ page.price }}</p>

      {% if page.description %}<p class="desc">{{ page.description }}</p>{% endif %}

      {% if page.colors %}
      <label class="colors-label">Color</label>
      <div class="colors">
        {% for c in page.colors %}
        <label class="color">
          <input type="radio" name="color" value="{{ c }}" {% if forloop.first %}checked{% endif %}> {{ c }}
        </label>
        {% endfor %}
      </div>
      {% endif %}

      {% if page.sizes %}
      <label class="sizes-label">Size</label>
      <div class="sizes">
        {% for s in page.sizes %}
        <label class="size">
          <input type="radio" name="size" value="{{ s }}" {% if forloop.first %}checked{% endif %}> {{ s }}
        </label>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Quantity stepper -->
      <div class="qty-control" data-qty>
        <button type="button" class="qty-btn" data-qty-dec aria-label="Decrease quantity">âˆ’</button>
        <span class="qty-val" aria-live="polite">1</span>
        <button type="button" class="qty-btn" data-qty-inc aria-label="Increase quantity">+</button>
      </div>

      {% if page.variant_ids %}
      <button class="btn primary" id="add-to-cart"
        data-variants='{{ page.variant_ids | jsonify }}'
        data-title="{{ page.title }}"
        data-price="{{ page.price }}"
        data-img="{{ page.featured_image | relative_url }}">
        Add to cart
      </button>
      {% endif %}

      {% if page.sku %}<p class="sku">SKU: {{ page.sku }}</p>{% endif %}
    </div>
  </div>
</article>

<script>
(function(){
  const hero = document.getElementById('hero');
  if(!hero) return;

  // Gallery thumbnails change hero image and selected color
  let selectedColor = document.querySelector('input[name="color"]:checked')?.value || '';
  document.querySelectorAll('.thumb').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      hero.src = btn.querySelector('img').src;
      hero.decoding='sync';
      const colorInput = document.querySelector(`input[name="color"][value="${btn.dataset.color}"]`);
      if(colorInput) colorInput.checked = true;
      selectedColor = btn.dataset.color;
    });
  });

  // Quantity stepper
  document.addEventListener('click', (e)=>{
    const dec = e.target.closest('[data-qty-dec]');
    const inc = e.target.closest('[data-qty-inc]');
    if(!dec && !inc) return;
    const wrap = (dec||inc).closest('[data-qty]');
    const valEl = wrap.querySelector('.qty-val');
    let n = parseInt(valEl.textContent || '1', 10) || 1;
    n += inc ? 1 : -1;
    n = Math.max(1, Math.min(99, n));
    valEl.textContent = n;
  });

  // Add to cart
  const btn = document.getElementById('add-to-cart');
  if(!btn) return;
  const variants = JSON.parse(btn.dataset.variants || '{}');

  btn.addEventListener('click', ()=>{
    const selColor = document.querySelector('input[name="color"]:checked')?.value;
    const selSize  = document.querySelector('input[name="size"]:checked')?.value;
    if(!selColor || !selSize){ alert('Please select color and size.'); return; }

    const key = selColor + ' ' + selSize; // matches variant_ids keys
    const variantId = variants[key];
    const qty = Math.max(1, parseInt(document.querySelector('.qty-val')?.textContent || '1', 10));

    if(!variantId){ alert('Variant not found for this color and size.'); return; }

    window.dispatchEvent(new CustomEvent('tm:add', { detail:{
      id: String(variantId), qty,
      title: btn.dataset.title, price: btn.dataset.price, img: btn.dataset.img
    }}));

    document.getElementById('mini-cart')?.classList.add('open');
    document.getElementById('cart-overlay')?.classList.add('show');
  });
})();
</script>
